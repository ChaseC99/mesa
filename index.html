<html>
    <head>
        <meta charset="UTF-8">
        <style>
            img {height: 95vh;}
            li:hover {cursor: pointer;} 
            #view {
                width: 40vw; 
                border: 1px solid #dee2e6; 
                overflow-y: scroll; 
                display: block;
                margin-bottom: 1rem;
            }
            tbody {
                display: table;
                width: 100%;
            }
        </style>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/imagemapster/1.5.4/jquery.imagemapster.min.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    </head>

    <div style="display: flex; margin: 0.5rem">
        <div>
            <img src="map.png" usemap="#image-map" id="map">

            <map name="image-map">
                <area target="" alt="d2_basketball" title="d2_basketball" href="" coords="523,80,756,198" shape="rect">
                <area target="" alt="d4_volleyball" title="d4_volleyball" href="" coords="623,901,499,983" shape="rect">
                <area target="" alt="d5_mailroom" title="d5_mailroom" href="" coords="522,1392,387,1313" shape="rect">
                <area target="" alt="d5_conejo" title="d5_conejo" href="" coords="537,1313,677,1394" shape="rect">
                <area target="" alt="d5_bathrooms" title="d5_bathrooms" href="" coords="387,1417,521,1503" shape="rect">
                <area target="" alt="d5_rec" title="d5_rec" href="" coords="677,1504,537,1418" shape="rect">
                <area target="" alt="d5_playa_roof" title="d5_playa_roof" href="" coords="179,1272,311,1345" shape="rect">
                <area target="" alt="d5_caballo_roof" title="d5_caballo_roof" href="" coords="153,1166,280,1236" shape="rect">
                <area target="" alt="d5_mariposa_roof" title="d5_mariposa_roof" href="" coords="124,1061,258,1136" shape="rect">
                <area target="" alt="d2_ho" title="d2_ho" href="" coords="382,443,479,525" shape="rect">
                <area target="" alt="d1_cc" title="d1_cc" href="" coords="659,590,675,523,699,513,760,547,767,579,729,624" shape="poly">
                <area target="" alt="d5_court" title="d5_court" href="" coords="314,1240,314,1279,342,1303,383,1277,369,1232" shape="poly">
                <area target="" alt="d3_puente" title="d3_puente" href="" coords="900,1444,922,1478,984,1461,935,1376,913,1376,887,1338,844,1354,842,1391,826,1409,829,1456,856,1463" shape="poly">
                <area target="" alt="d3_otero" title="d3_otero" href="" coords="875,1271,918,1357,942,1365,971,1399,1015,1376,1037,1287,1005,1269,960,1288,929,1246" shape="poly">
                <area target="" alt="d3_brisa" title="d3_brisa" href="" coords="773,1321,803,1339,846,1339,860,1317,820,1237,760,1194,729,1211,709,1278,715,1331" shape="poly">
                <area target="" alt="d3_cumbre" title="d3_cumbre" href="" coords="966,1228,985,1264,1024,1260,1042,1225,1054,1177,1039,1135,1000,1130,974,1146,950,1119,904,1134,902,1167,930,1223" shape="poly">
                <area target="" alt="d3_prado" title="d3_prado" href="" coords="855,1233,880,1198,896,1144,888,1104,843,1099,791,1084,747,1088,746,1121,776,1191" shape="poly">
                <area target="" alt="d3_ciudad" title="d3_ciudad" href="" coords="932,1045,956,1056,992,1039,981,985,901,922,873,939,875,1002,889,1054" shape="poly">
                <area target="" alt="d3_viento" title="d3_viento" href="" coords="786,1043,810,1060,842,1049,837,1000,840,958,810,950,751,976,714,1035,741,1073" shape="poly">
                <area target="" alt="d1_cielo" title="d1_cielo" href="" coords="631,897,657,883,703,910,735,981,720,1019,654,1022,630,987,631,940" shape="poly">
                <area target="" alt="d1_cuesta" title="d1_cuesta" href="" coords="735,894,774,905,796,893,750,790,688,782,678,845,691,897" shape="poly">
                <area target="" alt="d1_camino" title="d1_camino" href="" coords="813,903,864,880,908,895,922,854,911,779,797,823,793,862" shape="poly">
                <area target="" alt="d1_vista" title="d1_vista" href="" coords="1002,970,1064,937,971,760,920,783,932,861" shape="poly">
                <area target="" alt="d1_cascada" title="d1_cascada" href="" coords="966,659,968,736,1013,811,1044,822,1101,786,1074,707,1017,647" shape="poly">
                <area target="" alt="d1_estrella" title="d1_estrella" href="" coords="710,735,881,775,903,760,915,707,721,660" shape="poly">
                <area target="" alt="d1_niebla" title="d1_niebla" href="" coords="782,575,832,603,853,572,901,590,920,634,910,686,861,686,791,658,750,620" shape="poly">
                <area target="" alt="d4_sierra" title="d4_sierra" href="" coords="621,822,664,833,677,816,667,781,677,749,662,718,600,748,570,784,554,799,558,823,580,840" shape="poly">
                <area target="" alt="d4_bahia" title="d4_bahia" href="" coords="519,782,562,779,577,763,574,682,522,679,454,723,453,762,466,788" shape="poly">
                <area target="" alt="d4_lago" title="d4_lago" href="" coords="457,898,484,901,505,889,501,789,468,789,411,779,394,794,410,848" shape="poly">
                <area target="" alt="d4_loma" title="d4_loma" href="" coords="329,1004,444,949,435,891,383,895,327,898,328,933,317,968" shape="poly">
                <area target="" alt="d4_arroyo" title="d4_arroyo" href="" coords="272,933,307,942,325,931,318,875,326,837,312,819,270,829,246,815,213,826,233,878" shape="poly">
                <area target="" alt="d4_nubes" title="d4_nubes" href="" coords="267,751,301,761,432,697,447,667,422,621,245,703" shape="poly">
                <area target="" alt="d4_palo" title="d4_palo" href="" coords="452,616,466,642,609,678,643,668,656,615,465,565" shape="poly">
                <area target="" alt="d4_lluvia" title="d4_lluvia" href="" coords="241,656,303,653,387,612,387,581,320,530,271,554,223,605,229,633" shape="poly">
                <area target="" alt="d5_playa" title="d5_playa" href="" coords="379,1249,412,1266,573,1191,557,1137,412,1192,383,1210,376,1229" shape="poly">
                <area target="" alt="d5_caballo" title="d5_caballo" href="" coords="292,1150,457,1079,488,1088,468,1166,360,1217,344,1232,313,1232" shape="poly">
                <area target="" alt="d5_mariposa" title="d5_mariposa" href="" coords="283,1136,365,1101,480,1007,469,965,342,1037,304,970,252,1004,265,1092" shape="poly">
                <area target="" alt="d2_ondas" title="d2_ondas" href="" coords="491,553,524,571,581,583,651,568,647,513,581,505,582,470,529,460,522,495,493,495" shape="poly">
                <area target="" alt="d2_selva" title="d2_selva" href="" coords="510,386,564,389,577,308,602,306,603,258,574,230,516,232,511,283" shape="poly">
                <area target="" alt="d2_aldea" title="d2_aldea" href="" coords="571,403,629,421,722,436,729,381,654,355,646,327,605,326,581,348" shape="poly">
                <area target="" alt="d2_isla" title="d2_isla" href="" coords="747,433,763,390,840,405,859,394,900,408,912,445,899,488,837,478,771,457" shape="poly">
                <area target="" alt="d2_barranca" title="d2_barranca" href="" coords="912,401,930,451,929,488,950,528,1006,530,1043,507,953,370" shape="poly">
                <area target="" alt="d2_jardin" title="d2_jardin" href="" coords="779,350,804,370,833,358,892,394,932,355,797,257,772,304" shape="poly">
                <area target="" alt="d2_laguna" title="d2_laguna" href="" coords="609,250,612,299,690,311,698,329,749,333,773,289,768,244,676,240" shape="poly">
                <area target="" alt="d1" title="d1_done" href="" coords="79,246,151,318" shape="rect">
                <area target="" alt="d2" title="d2_done" href="" coords="152,248,226,316" shape="rect">
                <area target="" alt="d3" title="d3_done" href="" coords="226,248,296,317" shape="rect">
                <area target="" alt="d4" title="d4_done" href="" coords="300,245,373,314" shape="rect">
                <area target="" alt="d5" title="d5_done" href="" coords="375,246,451,314" shape="rect">
            </map>
        </div>

        <div style="margin-top: 13px;">
            <div class="nav nav-tabs" style="justify-content: space-between">
                <ul class="nav">
                    <li class="nav-item">
                        <a class="nav-link active" id="tab-facilities" onclick="setView('facilities')">Facilities</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="tab-log" onclick="setView('log')">Log</a>
                    </li>
                </ul>
                <ul class="nav">
                    <li class="nav-item">
                        <button class="btn btn-outline-danger" onclick="clearState()">ðŸ—‘ Reset the Map</button>
                    </li>
                </ul>
            </div>
            <table id="view" class="table table-responsive table-striped"></table>
        </div>
    </div>

    <script>
        // View can be "facilities", "positions", or "log"
        var view = "facilities"

        var loadedStates = JSON.parse(localStorage.getItem("states"));
        var states = loadedStates ? loadedStates : {};  

        const facilities = {
            "d1_cc": "Community Center/MPR",
            "d2_basketball": "Basketball Court",
            "d2_ho": "Housing Office",
            "d4_volleyball": "Volleyball Court",
            "d5_mailroom": "Mailroom",
            "d5_conejo": "Conejo Suite",
            "d5_bathrooms": "Playa Bathrooms",
            "d5_rec": "Rec and Fitness Center",
            "d5_court": "The Court",
            "d5_playa_roof": "Playa Roof",
            "d5_caballo_roof": "Caballo Roof",
            "d5_mariposa_roof": "Mariposa Roof"
        };
        
        const renderFacilities = () => {
            $('#view').html(
                "<tbody>" + 
                Object.keys(facilities).map(facility => {
                    const time = states[facility] ? states[facility] : '';
                    return `
                    <tr>
                        <td style="padding: 6px; width: 60%"><b>${facilities[facility]}</b></td>
                        <td style="padding: 6px">${time}</td>
                    </tr>
                    `
                }).toString().replaceAll(',','') +
                "</tbody>"   
            )
        }

        const renderPositions = () => {
            // TODO
        }

        const renderLog = () => {
            $('#view').html(
                "<tbody>" + 
                Object.keys(states).map(location => {
                    const time = states[location] ? states[location] : '';
                    return `
                    <tr>
                        <td style="padding: 6px; width: 60%"><b>${formatLocation(location)}</b></td>
                        <td style="padding: 6px">${time}</td>
                    </tr>
                    `
                }).reverse().toString().replaceAll(',','') + 
                "</tbody>"    
            )
        }

        $('#map').mapster({
            mapKey: 'title',
            fillColor: '1b1b1b',
            fillOpacity: 0.5,
            onClick: ({key, selected}) => {
                const currentTime = (new Date()).toLocaleTimeString();
                if (selected) {
                    states[key] = currentTime;
                } else {
                    delete states[key]
                }
                generateView();
                
                localStorage.setItem('states', JSON.stringify(states));
                console.log(states);
            },
            areas: Object.keys(states).map(key => {
               return {key: key, selected: true} 
            })
        });

        const generateView = () => {
            switch (view) {
                case "facilities": renderFacilities(); break;
                case "positions": renderPositions(); break;
                case "log": renderLog(); break;
            }
        }

        const clearState = () => { 
            if (confirm("Are you sure you want to reset the map?")) {
                localStorage.removeItem("states"); 
                location.reload();
            }
        }

        const formatLocation = (location) => {
            const [pos, loc] = location.split('_');

            if (location in facilities) {
                return pos.toUpperCase() + " " + facilities[location];
            }

            return pos.toUpperCase() + " " + loc[0].toUpperCase() + loc.slice(1);
        }

        const setView = (newView) => {
            $("#tab-"+view).removeClass("active");
            $("#tab-"+newView).addClass("active");
            view = newView;
            
            generateView();
        }

        generateView();
    </script>
</html>